;; -*- lexical-binding: t; -*-

(install-pkgs shrface
              shr-tag-pre-highlight)

(setq shr-use-fonts nil
      shr-use-colors nil
      shr-indentation 0
      shr-table-horizontal-line ?\-
      shr-width 80
      shr-indentation 4
      shr-inhibit-images nil
      shr-cookie-policy nil
      shr-image-ascent 'center
      eww-auto-rename-buffer 'title)

(add-hook 'eww-mode-hook #'display-line-numbers-mode)

(defun kk/shr-tag-pre-highlight (dom)
  "Place code in PRE inside an org src_block."
  (let* ((shr-folding-mode 'none)
         (shr-current-font 'default)
         (shr-external-rendering-functions ;; to fight against some stupid nested code tags
          (remove '(pre . kk/shr-tag-pre-highlight) shr-external-rendering-functions)))
    (shr-ensure-newline)
    (shr-ensure-newline)
    (setq start (point))
    (shr-insert (propertize "#+BEGIN_SRC\n" 'face 'org-block-begin-line))
    (shr-generic dom)
    (shr-ensure-newline)
    (setq inside-codeblock nil)
    (shr-insert (propertize "#+END_SRC" 'face 'org-block-end-line))
    (shr-ensure-newline)
    (setq end (point))
    (shr-ensure-newline)
    (shr-ensure-newline)
    (pcase (frame-parameter nil 'background-mode)
      ('light
       (add-face-text-property start end '(:background "#D8DEE9" :extend t)))
      ('dark
       (add-face-text-property start end '(:background "#292b2e" :extend t))))
    (shr-ensure-newline)))

(with-eval-after-load 'eww
  (require 'org-faces)
  (push '(pre . kk/shr-tag-pre-highlight) shr-external-rendering-functions))

(with-eval-after-load 'nov
  (push '(pre . kk/shr-tag-pre-highlight) nov-shr-rendering-functions))

(provide 'init-eww)
